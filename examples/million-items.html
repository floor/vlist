<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>vlist - Million Items (Compression Demo)</title>
        <link rel="stylesheet" href="../dist/vlist.css" />
        <style>
            * {
                box-sizing: border-box;
                margin: 0;
                padding: 0;
            }

            body {
                font-family:
                    -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
                    Oxygen, Ubuntu, sans-serif;
                background: #1a1a2e;
                color: #eee;
                padding: 20px;
                min-height: 100vh;
            }

            h1 {
                margin-bottom: 10px;
                color: #fff;
                display: flex;
                align-items: center;
                gap: 10px;
            }

            .badge {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                padding: 4px 12px;
                border-radius: 20px;
                font-size: 14px;
                font-weight: 600;
            }

            .badge.compressed {
                background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            }

            .description {
                color: #aaa;
                margin-bottom: 20px;
            }

            .metrics {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 12px;
                margin-bottom: 20px;
            }

            .metric {
                background: rgba(255, 255, 255, 0.05);
                border-radius: 12px;
                padding: 15px;
                text-align: center;
            }

            .metric-value {
                font-size: 28px;
                font-weight: 700;
                color: #667eea;
                font-family: "Monaco", "Menlo", monospace;
            }

            .metric-value.highlight {
                color: #43e97b;
            }

            .metric-value.warning {
                color: #fa709a;
            }

            .metric-label {
                font-size: 12px;
                color: #888;
                margin-top: 5px;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            .controls {
                display: flex;
                gap: 10px;
                margin-bottom: 20px;
                flex-wrap: wrap;
                align-items: center;
            }

            button {
                padding: 10px 20px;
                border: none;
                border-radius: 8px;
                background: rgba(102, 126, 234, 0.2);
                color: #667eea;
                font-size: 14px;
                font-weight: 500;
                cursor: pointer;
                transition: all 0.2s;
                border: 1px solid rgba(102, 126, 234, 0.3);
            }

            button:hover {
                background: rgba(102, 126, 234, 0.3);
            }

            button.primary {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border: none;
            }

            button.primary:hover {
                transform: translateY(-1px);
                box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
            }

            .size-toggle {
                display: flex;
                gap: 5px;
                background: rgba(255, 255, 255, 0.05);
                padding: 4px;
                border-radius: 8px;
                border: 1px solid rgba(255, 255, 255, 0.1);
            }

            .size-toggle button {
                background: transparent;
                color: #888;
                padding: 8px 16px;
                border: none;
                font-weight: 600;
            }

            .size-toggle button.active {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
            }

            .size-toggle button:hover:not(.active) {
                background: rgba(255, 255, 255, 0.1);
                color: #ccc;
            }

            input[type="number"] {
                padding: 10px 15px;
                border: 1px solid rgba(255, 255, 255, 0.1);
                border-radius: 8px;
                background: rgba(255, 255, 255, 0.05);
                color: #fff;
                font-size: 14px;
                width: 150px;
            }

            input[type="number"]:focus {
                outline: none;
                border-color: #667eea;
            }

            #list-container {
                height: 500px;
                background: rgba(255, 255, 255, 0.03);
                border-radius: 12px;
                border: 1px solid rgba(255, 255, 255, 0.1);
                overflow: hidden;
            }

            .item-content {
                display: flex;
                align-items: center;
                gap: 12px;
                padding: 0 16px;
                height: 100%;
                border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            }

            .item-index {
                width: 80px;
                font-family: "Monaco", "Menlo", monospace;
                font-size: 12px;
                color: #667eea;
            }

            .item-bar {
                flex: 1;
                height: 8px;
                background: rgba(255, 255, 255, 0.1);
                border-radius: 4px;
                overflow: hidden;
            }

            .item-bar-fill {
                height: 100%;
                border-radius: 4px;
                transition: width 0.3s ease;
            }

            .item-value {
                width: 60px;
                text-align: right;
                font-family: "Monaco", "Menlo", monospace;
                font-size: 13px;
                color: #aaa;
            }

            .item-hash {
                width: 100px;
                font-family: "Monaco", "Menlo", monospace;
                font-size: 11px;
                color: #555;
            }

            .performance-bar {
                margin-top: 20px;
                padding: 15px;
                background: rgba(255, 255, 255, 0.03);
                border-radius: 12px;
                border: 1px solid rgba(255, 255, 255, 0.1);
            }

            .perf-title {
                font-size: 12px;
                color: #888;
                margin-bottom: 10px;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            .perf-times {
                display: flex;
                gap: 20px;
                flex-wrap: wrap;
                font-family: "Monaco", "Menlo", monospace;
                font-size: 13px;
            }

            .perf-time {
                color: #aaa;
            }

            .perf-time span {
                color: #43e97b;
            }

            .loading-overlay {
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(26, 26, 46, 0.9);
                display: flex;
                align-items: center;
                justify-content: center;
                flex-direction: column;
                gap: 15px;
                border-radius: 12px;
                z-index: 10;
            }

            .loading-overlay.hidden {
                display: none;
            }

            .loading-spinner {
                width: 40px;
                height: 40px;
                border: 3px solid rgba(102, 126, 234, 0.3);
                border-top-color: #667eea;
                border-radius: 50%;
                animation: spin 1s linear infinite;
            }

            @keyframes spin {
                to {
                    transform: rotate(360deg);
                }
            }

            .loading-text {
                color: #888;
                font-size: 14px;
            }

            #list-wrapper {
                position: relative;
            }
        </style>
    </head>
    <body>
        <h1>
            ðŸš€ <span id="title-count">1 Million</span> Items
            <span class="badge compressed">Compressed</span>
        </h1>
        <p class="description">
            Testing vlist with <strong id="desc-count">1,000,000 items</strong>.
            Compression automatically handles the 16M pixel browser limit.
            <br /><small style="color: #43e97b"
                >âœ… Compression ratio: <span id="compression-ratio">--</span> |
                Virtual height: <span id="virtual-height">--</span></small
            >
        </p>

        <div class="metrics">
            <div class="metric">
                <div class="metric-value" id="total-items">0</div>
                <div class="metric-label">Total Items</div>
            </div>
            <div class="metric">
                <div class="metric-value highlight" id="dom-nodes">0</div>
                <div class="metric-label">DOM Nodes</div>
            </div>
            <div class="metric">
                <div class="metric-value" id="memory-saved">0%</div>
                <div class="metric-label">Memory Saved</div>
            </div>
            <div class="metric">
                <div class="metric-value" id="scroll-pos">0</div>
                <div class="metric-label">Scroll Position</div>
            </div>
            <div class="metric">
                <div class="metric-value" id="visible-range">0-0</div>
                <div class="metric-label">Visible Range</div>
            </div>
            <div class="metric">
                <div class="metric-value" id="fps">--</div>
                <div class="metric-label">FPS</div>
            </div>
        </div>

        <div class="controls">
            <div class="size-toggle">
                <button id="size-1m" class="active">1M</button>
                <button id="size-2m">2M</button>
                <button id="size-5m">5M</button>
            </div>
            <button class="primary" id="jump-random">Jump to Random</button>
            <button id="jump-start">Jump to Start</button>
            <button id="jump-middle">Jump to Middle</button>
            <button id="jump-end">Jump to End</button>
            <input
                type="number"
                id="jump-to"
                placeholder="Jump to index..."
                min="0"
            />
            <button id="jump-btn">Go</button>
        </div>

        <div id="list-wrapper">
            <div id="list-container"></div>
            <div class="loading-overlay hidden" id="loading-overlay">
                <div class="loading-spinner"></div>
                <div class="loading-text">Generating items...</div>
            </div>
        </div>

        <div class="performance-bar">
            <div class="perf-title">Performance Metrics</div>
            <div class="perf-times">
                <div class="perf-time">
                    Init: <span id="perf-init">--</span>
                </div>
                <div class="perf-time">
                    Generate: <span id="perf-generate">--</span>
                </div>
                <div class="perf-time">
                    Render: <span id="perf-render">--</span>
                </div>
                <div class="perf-time">
                    Last Scroll: <span id="perf-scroll">--</span>
                </div>
            </div>
        </div>

        <script type="module">
            import {
                createVList,
                getCompressionState,
                getCompressionInfo,
            } from "../dist/index.js";

            const ITEM_HEIGHT = 48;
            const SIZES = {
                "1m": 1_000_000,
                "2m": 2_000_000,
                "5m": 5_000_000,
            };

            const colors = [
                "linear-gradient(90deg, #667eea, #764ba2)",
                "linear-gradient(90deg, #f093fb, #f5576c)",
                "linear-gradient(90deg, #4facfe, #00f2fe)",
                "linear-gradient(90deg, #43e97b, #38f9d7)",
                "linear-gradient(90deg, #fa709a, #fee140)",
                "linear-gradient(90deg, #a8edea, #fed6e3)",
                "linear-gradient(90deg, #ff9a9e, #fecfef)",
                "linear-gradient(90deg, #ffecd2, #fcb69f)",
            ];

            // Simple hash function for consistent values
            const hash = (n) => {
                let h = n * 2654435761;
                h ^= h >>> 16;
                return Math.abs(h);
            };

            // Generate items on demand (lazy generation)
            const generateItem = (index) => ({
                id: index,
                value: hash(index) % 100,
                hash: hash(index).toString(16).slice(0, 8).toUpperCase(),
                color: colors[index % colors.length],
            });

            let list = null;
            let currentSize = "1m";
            let currentTotal = SIZES[currentSize];
            let items = [];

            // FPS counter
            let frameCount = 0;
            let lastFpsUpdate = performance.now();
            let currentFps = 0;

            const updateFps = () => {
                frameCount++;
                const now = performance.now();
                if (now - lastFpsUpdate >= 1000) {
                    currentFps = Math.round(
                        (frameCount * 1000) / (now - lastFpsUpdate),
                    );
                    document.getElementById("fps").textContent = currentFps;
                    document.getElementById("fps").className =
                        currentFps < 30
                            ? "metric-value warning"
                            : "metric-value highlight";
                    frameCount = 0;
                    lastFpsUpdate = now;
                }
                requestAnimationFrame(updateFps);
            };
            requestAnimationFrame(updateFps);

            // Update compression info display
            const updateCompressionInfo = (total) => {
                const compression = getCompressionState(total, ITEM_HEIGHT);
                console.log(getCompressionInfo(total, ITEM_HEIGHT));
                document.getElementById("compression-ratio").textContent =
                    `${(compression.ratio * 100).toFixed(1)}%`;
                document.getElementById("virtual-height").textContent =
                    `${(compression.virtualHeight / 1_000_000).toFixed(1)}M px`;
            };

            // Update title and description
            const updateTitleAndDesc = (total) => {
                const millions = total / 1_000_000;
                document.getElementById("title-count").textContent =
                    millions === 1 ? "1 Million" : `${millions} Million`;
                document.getElementById("desc-count").textContent =
                    total.toLocaleString() + " items";
                document.getElementById("jump-to").max = total - 1;
            };

            // Update metrics
            const updateMetrics = () => {
                const domNodes =
                    document.querySelectorAll(".vlist-item").length;
                const memorySaved = (
                    (1 - domNodes / currentTotal) *
                    100
                ).toFixed(4);

                document.getElementById("total-items").textContent =
                    currentTotal.toLocaleString();
                document.getElementById("dom-nodes").textContent = domNodes;
                document.getElementById("memory-saved").textContent =
                    `${memorySaved}%`;
            };

            // Create list function
            const createList = async (size) => {
                const total = SIZES[size];
                currentSize = size;
                currentTotal = total;

                // Show loading overlay
                document
                    .getElementById("loading-overlay")
                    .classList.remove("hidden");

                // Wait a frame to let the UI update
                await new Promise((resolve) => setTimeout(resolve, 10));

                // Destroy existing list
                if (list) {
                    list.destroy();
                }

                // Update UI
                updateTitleAndDesc(total);
                updateCompressionInfo(total);

                // Generate items
                console.time("Generate items");
                const generateStart = performance.now();
                items = Array.from({ length: total }, (_, i) =>
                    generateItem(i),
                );
                const generateTime = performance.now() - generateStart;
                console.timeEnd("Generate items");
                document.getElementById("perf-generate").textContent =
                    `${generateTime.toFixed(0)}ms`;

                // Create the list
                console.time("Create list");
                const initStart = performance.now();

                list = createVList({
                    container: "#list-container",
                    itemHeight: ITEM_HEIGHT,
                    items: items,
                    overscan: 5,
                    template: (item, index) => `
                        <div class="item-content">
                            <div class="item-index">#${(index + 1).toLocaleString()}</div>
                            <div class="item-bar">
                                <div class="item-bar-fill" style="width: ${item.value}%; background: ${item.color}"></div>
                            </div>
                            <div class="item-value">${item.value}%</div>
                            <div class="item-hash">${item.hash}</div>
                        </div>
                    `,
                });

                const initTime = performance.now() - initStart;
                console.timeEnd("Create list");

                document.getElementById("perf-init").textContent =
                    `${initTime.toFixed(2)}ms`;

                // Event handlers
                let lastScrollTime = 0;

                list.on("scroll", ({ scrollTop }) => {
                    const now = performance.now();
                    if (lastScrollTime > 0) {
                        const scrollTime = now - lastScrollTime;
                        document.getElementById("perf-scroll").textContent =
                            `${scrollTime.toFixed(2)}ms`;
                    }
                    lastScrollTime = now;

                    document.getElementById("scroll-pos").textContent =
                        Math.round(scrollTop).toLocaleString();
                    updateMetrics();
                });

                list.on("range:change", ({ range }) => {
                    document.getElementById("visible-range").textContent =
                        `${range.start.toLocaleString()}-${range.end.toLocaleString()}`;

                    const renderStart = performance.now();
                    requestAnimationFrame(() => {
                        const renderTime = performance.now() - renderStart;
                        document.getElementById("perf-render").textContent =
                            `${renderTime.toFixed(2)}ms`;
                    });
                });

                // Initial metrics
                updateMetrics();

                // Hide loading overlay
                document
                    .getElementById("loading-overlay")
                    .classList.add("hidden");
            };

            // Size toggle buttons
            document.getElementById("size-1m").addEventListener("click", () => {
                if (currentSize === "1m") return;
                document
                    .querySelectorAll(".size-toggle button")
                    .forEach((b) => b.classList.remove("active"));
                document.getElementById("size-1m").classList.add("active");
                createList("1m");
            });

            document.getElementById("size-2m").addEventListener("click", () => {
                if (currentSize === "2m") return;
                document
                    .querySelectorAll(".size-toggle button")
                    .forEach((b) => b.classList.remove("active"));
                document.getElementById("size-2m").classList.add("active");
                createList("2m");
            });

            document.getElementById("size-5m").addEventListener("click", () => {
                if (currentSize === "5m") return;
                document
                    .querySelectorAll(".size-toggle button")
                    .forEach((b) => b.classList.remove("active"));
                document.getElementById("size-5m").classList.add("active");
                createList("5m");
            });

            // Jump controls
            document
                .getElementById("jump-random")
                .addEventListener("click", () => {
                    const randomIndex = Math.floor(
                        Math.random() * currentTotal,
                    );
                    list.scrollToIndex(randomIndex, "center");
                });

            document
                .getElementById("jump-start")
                .addEventListener("click", () => {
                    list.scrollToIndex(0, "start");
                });

            document
                .getElementById("jump-middle")
                .addEventListener("click", () => {
                    list.scrollToIndex(Math.floor(currentTotal / 2), "center");
                });

            document
                .getElementById("jump-end")
                .addEventListener("click", () => {
                    list.scrollToIndex(currentTotal - 1, "end");
                });

            document
                .getElementById("jump-btn")
                .addEventListener("click", () => {
                    const input = document.getElementById("jump-to");
                    const index = parseInt(input.value);
                    if (!isNaN(index) && index >= 0 && index < currentTotal) {
                        list.scrollToIndex(index, "center");
                    }
                });

            document
                .getElementById("jump-to")
                .addEventListener("keypress", (e) => {
                    if (e.key === "Enter") {
                        document.getElementById("jump-btn").click();
                    }
                });

            // Initialize with 1M items
            createList("1m");
        </script>
    </body>
</html>
